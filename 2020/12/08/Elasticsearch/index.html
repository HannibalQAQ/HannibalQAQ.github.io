<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Elasticsearch | 木子文昍</title><meta name="keywords" content="教程,索引库,kibana,SpringDataElasticsearch"><meta name="author" content="Hannibal"><meta name="copyright" content="Hannibal"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="1.Elasticsearch介绍和安装1.1.简介1.1.1 简介  Elasticsearch是Elastic公司提供的一个基于Lucene的搜索服务器 是一个分布式，高扩展，高实时的搜索与数据分析引擎 基于RestFull的web调用接口，大大简化搜索开发流程 Elasticearch是用java语言开发的，开源的目前极其流行的企业级搜索引擎 Elastic官网：https:&#x2F;&#x2F;www.el">
<meta property="og:type" content="article">
<meta property="og:title" content="Elasticsearch">
<meta property="og:url" content="http://liwenchang.ren/2020/12/08/Elasticsearch/index.html">
<meta property="og:site_name" content="木子文昍">
<meta property="og:description" content="1.Elasticsearch介绍和安装1.1.简介1.1.1 简介  Elasticsearch是Elastic公司提供的一个基于Lucene的搜索服务器 是一个分布式，高扩展，高实时的搜索与数据分析引擎 基于RestFull的web调用接口，大大简化搜索开发流程 Elasticearch是用java语言开发的，开源的目前极其流行的企业级搜索引擎 Elastic官网：https:&#x2F;&#x2F;www.el">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png">
<meta property="article:published_time" content="2020-12-08T08:57:03.000Z">
<meta property="article:modified_time" content="2020-12-08T09:11:17.898Z">
<meta property="article:author" content="Hannibal">
<meta property="article:tag" content="教程">
<meta property="article:tag" content="索引库">
<meta property="article:tag" content="kibana">
<meta property="article:tag" content="SpringDataElasticsearch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://liwenchang.ren/2020/12/08/Elasticsearch/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-12-08 17:11:17'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/null" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">26</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">木子文昍</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Elasticsearch</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-12-08T08:57:03.000Z" title="发表于 2020-12-08 16:57:03">2020-12-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-12-08T09:11:17.898Z" title="更新于 2020-12-08 17:11:17">2020-12-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Elasticsearch/">Elasticsearch</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1-Elasticsearch介绍和安装"><a href="#1-Elasticsearch介绍和安装" class="headerlink" title="1.Elasticsearch介绍和安装"></a>1.Elasticsearch介绍和安装</h1><h2 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1.简介"></a>1.1.简介</h2><h3 id="1-1-1-简介"><a href="#1-1-1-简介" class="headerlink" title="1.1.1 简介"></a>1.1.1 简介</h3><p><img src="/2020/12/08/Elasticsearch/1578628464442.png"></p>
<ul>
<li>Elasticsearch是Elastic公司提供的一个基于Lucene的搜索服务器</li>
<li>是一个分布式，高扩展，高实时的搜索与数据分析引擎</li>
<li>基于RestFull的web调用接口，大大简化搜索开发流程</li>
<li>Elasticearch是用java语言开发的，开源的目前极其流行的企业级搜索引擎</li>
<li>Elastic官网：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/">https://www.elastic.co/cn/</a></li>
</ul>
<h3 id="1-1-2-与数据库对比"><a href="#1-1-2-与数据库对比" class="headerlink" title="1.1.2 与数据库对比"></a>1.1.2 与数据库对比</h3><ul>
<li>MySQL有事务，而Elasticearch没有事务，所以删除的数据无法恢复</li>
<li>Elasticearch没有外键的特性</li>
<li>MySQL注重数据的一致性和持久性，Elasticearch提供便捷的检索查询</li>
</ul>
<p><img src="/2020/12/08/Elasticsearch/1578629025076.png"></p>
<h2 id="1-2-安装Elasticsearch"><a href="#1-2-安装Elasticsearch" class="headerlink" title="1.2.安装Elasticsearch"></a>1.2.安装Elasticsearch</h2><p><strong>环境要求：JDK8及以上版本</strong></p>
<p><strong>（1） 将压缩包放到一个没有中文没有空格的位置，解压即可</strong></p>
<p><strong>（2）修改配置文件</strong></p>
<p>修改索引数据和日志数据存储的路径</p>
<p><img src="/2020/12/08/Elasticsearch/1.png"></p>
<p>第33行和37行，修改数存储位置和日志存储位置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Path to directory where to store the data (separate multiple locations by comma):</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="meta">path.data</span>: <span class="string">D:\Develop\elasticsearch-6.2.4\elasticsearch-6.2.4\data</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Path to log files:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="meta">path.logs</span>: <span class="string">D:\Develop\elasticsearch-6.2.4\elasticsearch-6.2.4\logs</span></span><br></pre></td></tr></table></figure>

<p><strong>（3）修改内存占用大小</strong></p>
<p>找到安装目录<code>config/jvm.options</code>文件 如图修改</p>
<p><img src="/2020/12/08/Elasticsearch/2.png"></p>
<p><strong>（4）进入bin目录中直接双击elasticsearch.bat文件。</strong></p>
<p><strong>（5） 测试访问</strong></p>
<p>双击<code>elasticsearch.bat</code>启动之后，后台输入如下内容</p>
<p><img src="/2020/12/08/Elasticsearch/1575454150869.png"></p>
<ul>
<li>可以看到绑定了两个端口:</li>
<li>9300：集群节点间通讯接口，接收tcp协议</li>
<li>9200：客户端访问接口，接收Http协议</li>
<li>我们在浏览器中访问：<a target="_blank" rel="noopener" href="http://127.0.0.1:9200/">http://127.0.0.1:9200</a></li>
</ul>
<p><img src="/2020/12/08/Elasticsearch/3.png"></p>
<h2 id="1-3-安装kibana"><a href="#1-3-安装kibana" class="headerlink" title="1.3.安装kibana"></a>1.3.安装kibana</h2><h3 id="1-3-1-什么是Kibana"><a href="#1-3-1-什么是Kibana" class="headerlink" title="1.3.1.什么是Kibana"></a>1.3.1.什么是Kibana</h3><p><img src="/2020/12/08/Elasticsearch/1526481256534.png"></p>
<ul>
<li>Kibana是一个基于Node.js的Elasticsearch索引库数据统计工具;</li>
<li>利用Elasticsearch的聚合功能，生成各种图表，如柱形图，线状图，饼图等。</li>
<li>提供了操作Elasticsearch索引数据的控制台，并且提供了一定的API提示。</li>
</ul>
<h3 id="1-3-2-安装"><a href="#1-3-2-安装" class="headerlink" title="1.3.2.安装"></a>1.3.2.安装</h3><p><strong>（1） 安装NodeJS</strong></p>
<p>因为Kibana依赖于node，需要在windows下先安装Node.js，一路下一步即可安装成功，然后在任意黑窗口输入名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br></pre></td></tr></table></figure>

<p>可以查看到node版本，如下：</p>
<p><img src="/2020/12/08/Elasticsearch/1555584029808.png"> </p>
<p><strong>（2） 安装kibana</strong></p>
<p>安装kibana，版本与elasticsearch保持一致</p>
<p>解压压缩包即可：</p>
<p> <img src="/2020/12/08/Elasticsearch/4.png"></p>
<h3 id="1-3-3-配置运行"><a href="#1-3-3-配置运行" class="headerlink" title="1.3.3.配置运行"></a>1.3.3.配置运行</h3><p>**（1） **配置</p>
<p>进入安装目录下的config目录，修改kibana.yml文件：</p>
<p>修改elasticsearch服务器的地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch.url: &quot;http:&#x2F;&#x2F;localhost:9200&quot;</span><br></pre></td></tr></table></figure>

<p>**（1） **运行</p>
<p>进入安装目录下的bin目录，双击运行：</p>
<p><img src="/2020/12/08/Elasticsearch/5.png"></p>
<p>发现kibana的监听端口是5601</p>
<p>我们访问：<a target="_blank" rel="noopener" href="http://127.0.0.1:5601/">http://127.0.0.1:5601</a></p>
<h3 id="1-3-4-控制台"><a href="#1-3-4-控制台" class="headerlink" title="1.3.4.控制台"></a>1.3.4.控制台</h3><p>选择左侧的DevTools菜单，即可进入控制台页面：</p>
<p> <img src="/2020/12/08/Elasticsearch/6.png"></p>
<h2 id="1-4-安装ik分词器"><a href="#1-4-安装ik分词器" class="headerlink" title="1.4 安装ik分词器"></a>1.4 安装ik分词器</h2><h3 id="1-4-1-安装"><a href="#1-4-1-安装" class="headerlink" title="1.4.1.安装"></a>1.4.1.安装</h3><ol>
<li>解压分词器压缩包后,将解压后的文件夹拷贝到elasticsearch\plugins下，并重命名文件夹为ik</li>
<li>重新启动ElasticSearch，即可加载IK分词器</li>
</ol>
<h3 id="1-5-2-测试"><a href="#1-5-2-测试" class="headerlink" title="1.5.2.测试"></a>1.5.2.测试</h3><p>在kibana控制台输入下面的请求：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>:     <span class="string">&quot;我是中国人&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行得到结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;我&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;CN_CHAR&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;是&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;CN_CHAR&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span>: <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;中国人&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span>: <span class="number">5</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span>: <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;中国&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span>: <span class="number">4</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span>: <span class="number">3</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;国人&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span>: <span class="number">3</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span>: <span class="number">5</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span>: <span class="number">4</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="2-使用kibana对索引库操作"><a href="#2-使用kibana对索引库操作" class="headerlink" title="2.使用kibana对索引库操作"></a>2.使用kibana对索引库操作</h1><h2 id="2-1-基本概念"><a href="#2-1-基本概念" class="headerlink" title="2.1.基本概念"></a>2.1.基本概念</h2><p>Elasticsearch也是基于Lucene的全文检索库，本质也是存储数据，很多概念与MySQL类似的。</p>
<ul>
<li><p><strong>索引（index）</strong></p>
<p>Elasticsearch存储数据的地方，可以理解为Database 数据库</p>
</li>
<li><p><strong>映射（mapping）</strong></p>
<p>mapping定义了每个字段的类型，分词器等。可以理解为数据库的表结构</p>
</li>
<li><p><strong>类型（type）</strong></p>
<p>一种type相当于数据库中的一张表</p>
<blockquote>
<p>Es5.x : 一个index可以有多个type</p>
<p>Es6.x：一个index只有一个type</p>
<p>Es7.x：逐步删除type概念，统一称为_doc</p>
</blockquote>
</li>
<li><p><strong>文档（Document）</strong></p>
<p>Elasticsearch中的最小存储单元，json格式。相当于数据库中的一条记录</p>
</li>
<li><p><strong>字段（Field）</strong></p>
<p>相当于数据库中的列</p>
</li>
</ul>
<h2 id="2-2-创建索引库"><a href="#2-2-创建索引库" class="headerlink" title="2.2.创建索引库"></a>2.2.创建索引库</h2><h3 id="2-2-1-语法"><a href="#2-2-1-语法" class="headerlink" title="2.2.1.语法"></a>2.2.1.语法</h3><p>创建索引的请求格式：</p>
<ul>
<li><p>请求方式：PUT</p>
</li>
<li><p>请求路径：/索引库名</p>
</li>
<li><p>请求参数：json格式：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;属性名&quot;</span>: <span class="string">&quot;属性值&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>settings：就是索引库设置，可以定义索引库的各种属性，目前我们可以不设置，都走默认。</p>
</li>
</ul>
<h3 id="2-2-2-使用kibana创建"><a href="#2-2-2-使用kibana创建" class="headerlink" title="2.2.2.使用kibana创建"></a>2.2.2.使用kibana创建</h3><p>kibana的控制台，可以对http请求进行简化，示例：</p>
<p><img src="/2020/12/08/Elasticsearch/7.png"></p>
<p>相当于是省去了elasticsearch的服务器地址</p>
<h2 id="2-3-查看索引库"><a href="#2-3-查看索引库" class="headerlink" title="2.3.查看索引库"></a>2.3.查看索引库</h2><p>Get请求可以帮我们查看索引信息，格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;索引库名</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/08/Elasticsearch/8.png"></p>
<h2 id="2-4-删除索引库"><a href="#2-4-删除索引库" class="headerlink" title="2.4.删除索引库"></a>2.4.删除索引库</h2><p>删除索引使用DELETE请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE &#x2F;索引库名</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/08/Elasticsearch/9.png"></p>
<p>再次查看test：</p>
<p><img src="/2020/12/08/Elasticsearch/10.png"></p>
<h1 id="3-使用kibana对类型及映射操作"><a href="#3-使用kibana对类型及映射操作" class="headerlink" title="3.使用kibana对类型及映射操作"></a>3.使用kibana对类型及映射操作</h1><p>有了<code>索引库</code>，等于有了数据库中的<code>database</code>。接下来就需要索引库中的<code>类型</code>了，也就是数据库中的<code>表</code>。创建数据库表需要设置字段约束，索引库也一样，在创建索引库的类型时，需要知道这个类型下有哪些字段，每个字段有哪些<strong>约束</strong>信息，这就叫做<code>字段映射(mapping)</code></p>
<h2 id="3-1-创建字段映射"><a href="#3-1-创建字段映射" class="headerlink" title="3.1.创建字段映射"></a>3.1.创建字段映射</h2><p>请求方式依然是PUT</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">PUT</span> <span class="string">/索引库名/_mapping/类型名称</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">    <span class="string">&quot;字段名&quot;</span><span class="string">:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;类型&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;index&quot;:</span> <span class="literal">true</span><span class="string">，</span></span><br><span class="line">      <span class="attr">&quot;store&quot;:</span> <span class="literal">true</span><span class="string">，</span></span><br><span class="line">      <span class="attr">&quot;analyzer&quot;:</span> <span class="string">&quot;分词器&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>类型名称：就是前面将的type的概念，类似于数据库中的表<br>字段名：任意填写，下面指定许多属性，例如：</li>
<li>type：类型，可以是text、long、short、date、integer、object等</li>
<li>index：是否索引，默认为true</li>
<li>store：是否存储，默认为false</li>
<li>analyzer：分词器，这里的<code>ik_max_word</code>即使用ik分词器</li>
</ul>
<blockquote>
<p>示例</p>
</blockquote>
<p>发起请求：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT test/_mapping/student</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;acknowledged&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-2-查看映射关系"><a href="#3-2-查看映射关系" class="headerlink" title="3.2.查看映射关系"></a>3.2.查看映射关系</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;索引库名&#x2F;_mapping</span><br></pre></td></tr></table></figure>

<p>查看某个索引库中的所有类型的映射。如果要查看某个类型映射，可以再路径后面跟上类型名称。即：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;索引库名&#x2F;_mapping&#x2F;映射名</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;test&#x2F;_mapping</span><br></pre></td></tr></table></figure>

<blockquote>
<p>响应：</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;test&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;student&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-3-映射属性详解"><a href="#3-3-映射属性详解" class="headerlink" title="3.3.映射属性详解"></a>3.3.映射属性详解</h2><h4 id="1）type"><a href="#1）type" class="headerlink" title="1）type"></a>1）type</h4><p>Elasticsearch中支持的数据类型非常丰富：</p>
<p> <img src="/2020/12/08/Elasticsearch/1526523877042.png"></p>
<ul>
<li><p>String类型，又分两种：</p>
<ul>
<li>text：可分词，不可参与聚合</li>
<li>keyword：不可分词，数据会作为完整字段进行匹配，可以参与聚合</li>
</ul>
</li>
<li><p>Numerical：数值类型，分两类</p>
<ul>
<li>基本数据类型：long、interger、short、byte、double、float、half_float</li>
<li>浮点数的高精度类型：scaled_float<ul>
<li>需要指定一个精度因子，比如10或100。elasticsearch会把真实值乘以这个因子后存储，取出时再还原。</li>
</ul>
</li>
</ul>
</li>
<li><p>Date：日期类型</p>
<p>elasticsearch可以对日期格式化为字符串存储，但是建议我们存储为毫秒值，存储为long，节省空间。</p>
</li>
<li><p>Array：数组类型</p>
<ul>
<li>进行匹配时，任意一个元素满足，都认为满足</li>
<li>排序时，如果升序则用数组中的最小值来排序，如果降序则用数组中的最大值来排序</li>
</ul>
</li>
<li><p>Object：对象</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    name:&quot;Jack&quot;,</span><br><span class="line">    age:21,</span><br><span class="line">   	girl:&#123;</span><br><span class="line">		name: &quot;Rose&quot;,</span><br><span class="line">        age:21</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果存储到索引库的是对象类型，例如上面的girl，会把girl编程两个字段：girl.name和girl.age</p>
<h4 id="2）index"><a href="#2）index" class="headerlink" title="2）index"></a>2）index</h4><p>index影响字段的索引情况。</p>
<ul>
<li>true：字段会被索引，则可以用来进行搜索过滤。默认值就是true</li>
<li>false：字段不会被索引，不能用来搜索</li>
</ul>
<p>index的默认值就是true，也就是说你不进行任何配置，所有字段都会被索引。</p>
<p>但是有些字段是我们不希望被索引的，就需要手动设置index为false。</p>
<h4 id="3）store"><a href="#3）store" class="headerlink" title="3）store"></a>3）store</h4><p>是否将数据进行额外存储。</p>
<p>在Elasticsearch中，即便store设置为false，也可以搜索到结果。</p>
<p>原因是Elasticsearch在创建文档索引时，会将文档中的原始数据备份，保存到一个叫做<code>_source</code>的属性中。而且我们可以通过过滤<code>_source</code>来选择哪些要显示，哪些不显示。</p>
<p>而如果设置store为true，就会在<code>_source</code>以外额外存储一份数据，多余，因此一般我们都会将store设置为false，事实上，store的默认值就是false。</p>
<h4 id="4）boost"><a href="#4）boost" class="headerlink" title="4）boost"></a>4）boost</h4><p>权重，新增数据时，可以指定该数据的权重，权重越高，得分越高，排名越靠前。</p>
<h2 id="3-4-一次创建索引库和类型"><a href="#3-4-一次创建索引库和类型" class="headerlink" title="3.4.一次创建索引库和类型"></a>3.4.一次创建索引库和类型</h2><p>刚才 的案例中我们是把创建索引库和类型分开来做，其实也可以在创建索引库的同时，直接制定索引库中的类型，基本语法：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">put /索引库名</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;settings&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;索引库属性名&quot;</span>:<span class="string">&quot;索引库属性值&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;类型名&quot;</span>:&#123;</span><br><span class="line">            <span class="attr">&quot;properties&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;字段名&quot;</span>:&#123;</span><br><span class="line">                    <span class="attr">&quot;映射属性名&quot;</span>:<span class="string">&quot;映射属性值&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来试一下吧：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PUT /test1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>: &#123;&#125;, </span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;student1&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;acknowledged&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;shards_acknowledged&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;test1&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-使用kibana对文档操作"><a href="#4-使用kibana对文档操作" class="headerlink" title="4.使用kibana对文档操作"></a>4.使用kibana对文档操作</h1><p>文档，即索引库中某个类型下的数据，会根据规则创建索引，将来用来搜索。可以类比做数据库中的每一行数据。</p>
<h2 id="4-1-新增文档"><a href="#4-1-新增文档" class="headerlink" title="4.1.新增文档"></a>4.1.新增文档</h2><h3 id="4-1-1-新增并随机生成id"><a href="#4-1-1-新增并随机生成id" class="headerlink" title="4.1.1 新增并随机生成id"></a>4.1.1 新增并随机生成id</h3><p>通过POST请求，可以向一个已经存在的索引库中添加文档数据。</p>
<blockquote>
<p>语法：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;索引库名&#x2F;类型名</span><br><span class="line">&#123;</span><br><span class="line">    &quot;key&quot;:&quot;value&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>示例：</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /test/student/</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span>:<span class="number">24</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;Y7TvEXIB8UFTVsLwtJkV&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;result&quot;</span>: <span class="string">&quot;created&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到结果显示为：<code>created</code>，应该是创建成功了。</p>
<p>在响应结果中有个<code>_id</code>字段，这个就是这条文档数据的<code>唯一标示</code>，增删改查都依赖这个id作为唯一标示。</p>
<p>可以看到id的值为：Y7TvEXIB8UFTVsLwtJkV,这里我们新增时没有指定id，所以是ES帮我们随机生成的id。</p>
<h3 id="4-1-2-新增文档并自定义id"><a href="#4-1-2-新增文档并自定义id" class="headerlink" title="4.1.2 新增文档并自定义id"></a>4.1.2 新增文档并自定义id</h3><p>如果我们想要自己新增的时候指定id，可以这么做：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;索引库名&#x2F;类型&#x2F;id值</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /test/student/2</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;李四&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span>:<span class="number">25</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到的数据：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;result&quot;</span>: <span class="string">&quot;created&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-2-查看文档"><a href="#4-2-查看文档" class="headerlink" title="4.2.查看文档"></a>4.2.查看文档</h2><p>通过kibana查看数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /test/student/Y7TvEXIB8UFTVsLwtJkV</span><br></pre></td></tr></table></figure>

<p>查看结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;Y7TvEXIB8UFTVsLwtJkV&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;found&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span>: <span class="number">24</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>_source</code>：源文档信息，所有的数据都在里面。</li>
<li><code>_id</code>：这条文档的唯一标示</li>
</ul>
<h2 id="4-3-修改数据"><a href="#4-3-修改数据" class="headerlink" title="4.3.修改数据"></a>4.3.修改数据</h2><p>把刚才post的请求方式改为PUT，就是修改了。不过修改必须指定id，</p>
<ul>
<li>id对应文档存在，则修改</li>
<li>id对应文档不存在，则新增</li>
</ul>
<p>比如，我们把使用id为3，不存在，则应该是新增：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /test/student/3</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;王五&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span>:<span class="number">30</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;3&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;result&quot;</span>: <span class="string">&quot;created&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到是<code>created</code>，是新增。</p>
<p>我们再次执行刚才的请求，不过把数据改一下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /test/student/3</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;王五1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span>:<span class="number">30</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;3&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">&quot;result&quot;</span>: <span class="string">&quot;updated&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到结果是：<code>updated</code>，显然是更新数据</p>
<h2 id="4-4-删除数据"><a href="#4-4-删除数据" class="headerlink" title="4.4.删除数据"></a>4.4.删除数据</h2><p>删除使用DELETE请求，同样，需要根据id进行删除：</p>
<blockquote>
<p>语法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DELETE &#x2F;索引库名&#x2F;类型名&#x2F;id值</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>示例：</p>
</blockquote>
<p> <img src="/2020/12/08/Elasticsearch/11.png"></p>
<h2 id="4-5-智能判断"><a href="#4-5-智能判断" class="headerlink" title="4.5.智能判断"></a>4.5.智能判断</h2><p>事实上Elasticsearch非常智能，你不需要给索引库设置任何mapping映射，它也可以根据你输入的数据来判断类型，动态添加数据映射。</p>
<p>测试一下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /test/student/3</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;王五&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span>:<span class="number">25</span>,</span><br><span class="line">    <span class="attr">&quot;sex&quot;</span>:<span class="string">&quot;男&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们额外添加了stock库存，saleable是否上架，subtitle副标题、3个字段。</p>
<p>成功了！在看下索引库的映射关系:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;test&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;student&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;sex&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;fields&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;keyword&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;ignore_above&quot;</span>: <span class="number">256</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sex是String类型数据，ES无法智能判断，它就会存入两个字段。例如：</p>
<ul>
<li>subtitle：text类型</li>
<li>subtitle.keyword：keyword类型</li>
</ul>
<p>这种智能映射，底层原理是动态模板映射，如果我们想修改这种智能映射的规则，其实只要修改动态模板即可！</p>
<h2 id="4-6-动态映射模板"><a href="#4-6-动态映射模板" class="headerlink" title="4.6.动态映射模板"></a>4.6.动态映射模板</h2><p>动态模板的语法：</p>
<p><img src="/2020/12/08/Elasticsearch/1547005993592.png"> </p>
<p>1）模板名称，随便起</p>
<p>2）匹配条件，凡是符合条件的未定义字段，都会按照这个规则来映射</p>
<p>3）映射规则，匹配成功后的映射规则</p>
<p>举例，我们可以把所有未映射的string类型数据自动映射为keyword类型：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PUT test1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;student&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;dynamic_templates&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;strings&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;match_mapping_type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;mapping&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个案例中，我们把做了两个映射配置：</p>
<ul>
<li>title字段：统一映射为text类型，并制定分词器</li>
<li>其它字段：只要是string类型，统一都处理为keyword类型。</li>
</ul>
<p>这样，未知的string类型数据就不会被映射为text和keyword并存，而是统一以keyword来处理！</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /test1/sutdent/1</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;张三1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;sex&quot;</span>:<span class="string">&quot;女&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span>:<span class="number">30</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们只对那么做了配置，现在来看看sex和age会被映射为什么类型呢：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;test1&#x2F;_mapping</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;test1&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;sutdent&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;long&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;fields&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;keyword&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;ignore_above&quot;</span>: <span class="number">256</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;sex&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;fields&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;keyword&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;ignore_above&quot;</span>: <span class="number">256</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到sex被映射成了keyword，而非之前的text和keyword并存，说明我们的动态模板生效了！</p>
<h1 id="5-kibana查询文档"><a href="#5-kibana查询文档" class="headerlink" title="5.kibana查询文档"></a>5.kibana查询文档</h1><p>我们从4块来讲查询：</p>
<ul>
<li>基本查询    </li>
<li><code>_source</code>过滤</li>
<li>结果过滤</li>
<li>高级查询</li>
<li>排序</li>
</ul>
<h2 id="5-1-基本查询"><a href="#5-1-基本查询" class="headerlink" title="5.1.基本查询"></a>5.1.基本查询</h2><blockquote>
<p>基本语法</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /索引库名/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;查询类型&quot;</span>:&#123;</span><br><span class="line">            <span class="attr">&quot;查询条件&quot;</span>:<span class="string">&quot;查询条件值&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的query代表一个查询对象，里面可以有不同的查询属性</p>
<ul>
<li>查询类型：<ul>
<li>例如：<code>match_all</code>， <code>match</code>，<code>term</code> ， <code>range</code> 等等</li>
</ul>
</li>
<li>查询条件：查询条件会根据类型的不同，写法也有差异</li>
</ul>
<h3 id="5-1-1-查询所有（match-all"><a href="#5-1-1-查询所有（match-all" class="headerlink" title="5.1.1 查询所有（match_all)"></a>5.1.1 查询所有（match_all)</h3><blockquote>
<p>示例：</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /test/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>query</code>：代表查询对象</li>
<li><code>match_all</code>：代表查询所有</li>
</ul>
<blockquote>
<p>结果：</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;Y7TvEXIB8UFTVsLwtJkV&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">24</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;李四&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">25</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;3&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;王五&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">25</span>,</span><br><span class="line">          <span class="attr">&quot;sex&quot;</span>: <span class="string">&quot;男&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>took：查询花费时间，单位是毫秒</li>
<li>time_out：是否超时</li>
<li>_shards：分片信息</li>
<li>hits：搜索结果总览对象<ul>
<li>total：搜索到的总条数</li>
<li>max_score：所有结果中文档得分的最高分</li>
<li>hits：搜索结果的文档对象数组，每个元素是一条搜索到的文档信息<ul>
<li>_index：索引库</li>
<li>_type：文档类型</li>
<li>_id：文档id</li>
<li>_score：文档得分</li>
<li>_source：文档的源数据</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="5-1-2-匹配查询（match）"><a href="#5-1-2-匹配查询（match）" class="headerlink" title="5.1.2 匹配查询（match）"></a>5.1.2 匹配查询（match）</h3><ul>
<li>or关系</li>
</ul>
<p><code>match</code>类型查询，会把查询条件进行分词，然后进行查询,多个词条之间是or的关系</p>
<ul>
<li>and关系</li>
</ul>
<p>某些情况下，我们需要更精确查找，我们希望这个关系变成<code>and</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /test/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;match&quot;</span>:&#123;</span><br><span class="line">            <span class="attr">&quot;查询条件&quot;</span>:&#123;<span class="attr">&quot;query&quot;</span>:<span class="string">&quot;查询值&quot;</span>,<span class="attr">&quot;operator&quot;</span>:<span class="string">&quot;and&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-1-3-词条匹配-term"><a href="#5-1-3-词条匹配-term" class="headerlink" title="5.1.3 词条匹配(term)"></a>5.1.3 词条匹配(term)</h3><p><code>term</code> 查询被用于精确值 匹配，这些精确值可能是数字、时间、布尔或者那些<strong>未分词</strong>的字符串</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /test/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;term&quot;</span>:&#123;</span><br><span class="line">            <span class="attr">&quot;age&quot;</span>:<span class="number">30</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;李四&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">25</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;3&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;王五&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">25</span>,</span><br><span class="line">          <span class="attr">&quot;sex&quot;</span>: <span class="string">&quot;男&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-1-4-布尔组合（bool"><a href="#5-1-4-布尔组合（bool" class="headerlink" title="5.1.4 布尔组合（bool)"></a>5.1.4 布尔组合（bool)</h3><p><code>bool</code>把各种其它查询通过<code>must</code>（与）、<code>must_not</code>（非）、<code>should</code>（或）的方式进行组合</p>
<p>bool支持嵌套过滤器完成数据结果过滤</p>
<p>must (and) ： 条件必须成立</p>
<p>must_not (not) :条件必须不成立</p>
<p>should (or) : 条件可以成立</p>
<p>filter：条件必须成立，性能比must高，不会计算得分 </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET /test/student/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;must&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;gte&quot;</span>: <span class="number">20</span>,</span><br><span class="line">            <span class="attr">&quot;lte&quot;</span>: <span class="number">25</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-1-5-范围查询-range"><a href="#5-1-5-范围查询-range" class="headerlink" title="5.1.5 范围查询(range)"></a>5.1.5 范围查询(range)</h3><p><code>range</code> 查询找出那些落在指定区间内的数字或者时间</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /test/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;age&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;gte&quot;</span>:  <span class="number">20</span>,</span><br><span class="line">                <span class="attr">&quot;lt&quot;</span>:   <span class="number">25</span></span><br><span class="line">            &#125;</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>range</code>查询允许以下字符：</p>
<table>
<thead>
<tr>
<th align="center">操作符</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">gt</td>
<td align="center">大于</td>
</tr>
<tr>
<td align="center">gte</td>
<td align="center">大于等于</td>
</tr>
<tr>
<td align="center">lt</td>
<td align="center">小于</td>
</tr>
<tr>
<td align="center">lte</td>
<td align="center">小于等于</td>
</tr>
</tbody></table>
<h3 id="5-1-6-模糊查询-fuzzy"><a href="#5-1-6-模糊查询-fuzzy" class="headerlink" title="5.1.6 模糊查询(fuzzy)"></a>5.1.6 模糊查询(fuzzy)</h3><p><code>fuzzy</code> 查询是 <code>term</code> 查询的模糊等价。它允许用户搜索词条与实际词条的拼写出现偏差，但是偏差的编辑距离不得超过2</p>
<p>我们可以通过<code>fuzziness</code>来指定允许的编辑距离：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /索引库名/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;fuzzy&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;查询条件&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>:<span class="string">&quot;值&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;fuzziness&quot;</span>:<span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-2-结果过滤"><a href="#5-2-结果过滤" class="headerlink" title="5.2.结果过滤"></a>5.2.结果过滤</h2><p>默认情况下，elasticsearch在搜索的结果中，会把文档中保存在<code>_source</code>的所有字段都返回。</p>
<p>如果我们只想获取其中的部分字段，我们可以添加<code>_source</code>的过滤</p>
<h3 id="5-2-1-直接指定字段"><a href="#5-2-1-直接指定字段" class="headerlink" title="5.2.1.直接指定字段"></a>5.2.1.直接指定字段</h3><p>示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /test/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span>: [<span class="string">&quot;name&quot;</span>,<span class="string">&quot;age&quot;</span>],</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;age&quot;</span>: <span class="number">25</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回的结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span>: <span class="number">23</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;李四&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">25</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;3&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;王五&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">25</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-2-指定includes和excludes"><a href="#5-2-2-指定includes和excludes" class="headerlink" title="5.2.2.指定includes和excludes"></a>5.2.2.指定includes和excludes</h3><p>我们也可以通过：</p>
<ul>
<li>includes：来指定想要显示的字段</li>
<li>excludes：来指定不想要显示的字段</li>
</ul>
<p>二者都是可选的。</p>
<p>示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /test/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;includes&quot;</span>:[<span class="string">&quot;name&quot;</span>,<span class="string">&quot;age&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;age&quot;</span>: <span class="number">24</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与下面的结果将是一样的：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /test/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">     <span class="attr">&quot;excludes&quot;</span>: [<span class="string">&quot;sex&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;age&quot;</span>: <span class="number">24</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-3-排序"><a href="#5-3-排序" class="headerlink" title="5.3 排序"></a>5.3 排序</h2><h3 id="5-3-1-单字段排序"><a href="#5-3-1-单字段排序" class="headerlink" title="5.3.1 单字段排序"></a>5.3.1 单字段排序</h3><p><code>sort</code> 可以让我们按照不同的字段进行排序，并且通过<code>order</code>指定排序的方式</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /test/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;age&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-2-多字段排序"><a href="#5-3-2-多字段排序" class="headerlink" title="5.3.2 多字段排序"></a>5.3.2 多字段排序</h3><p>假定我们想要结合使用 age和 _id 进行查询，并且匹配的结果首先按照年龄排序，然后按照相id排序：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /test/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">    <span class="attr">&quot;sort&quot;</span>: [</span><br><span class="line">      &#123; <span class="attr">&quot;age&quot;</span>: &#123; <span class="attr">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span> &#125;&#125;,</span><br><span class="line">      &#123; <span class="attr">&quot;_id&quot;</span>: &#123; <span class="attr">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span> &#125;&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-4-分页"><a href="#5-4-分页" class="headerlink" title="5.4.分页"></a>5.4.分页</h2><p>elasticsearch的分页与mysql数据库非常相似，都是指定两个值：</p>
<ul>
<li>from：开始位置</li>
<li>size：每页大小</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /test/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;age&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;order&quot;</span>: <span class="string">&quot;asc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;from&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;李四&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">25</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;sort&quot;</span>: [</span><br><span class="line">          <span class="number">25</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;3&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;王五&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">25</span>,</span><br><span class="line">          <span class="attr">&quot;sex&quot;</span>: <span class="string">&quot;男&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;sort&quot;</span>: [</span><br><span class="line">          <span class="number">25</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-5-高亮"><a href="#5-5-高亮" class="headerlink" title="5.5.高亮"></a>5.5.高亮</h2><p>高亮原理：</p>
<ul>
<li>服务端搜索数据，得到搜索结果</li>
<li>把搜索结果中，搜索关键字都加上约定好的标签</li>
<li>前端页面提前写好标签的CSS样式，即可高亮</li>
</ul>
<p>elasticsearch中实现高亮的语法比较简单：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /test/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;pre_tags&quot;</span>: <span class="string">&quot;&lt;em&gt;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;post_tags&quot;</span>: <span class="string">&quot;&lt;/em&gt;&quot;</span>, </span><br><span class="line">    <span class="attr">&quot;fields&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在使用match查询的同时，加上一个highlight属性：</p>
<ul>
<li>pre_tags：前置标签</li>
<li>post_tags：后置标签</li>
<li>fields：需要高亮的字段<ul>
<li>title：这里声明title字段需要高亮，后面可以为这个字段设置特有配置，也可以空</li>
</ul>
</li>
</ul>
<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span>: <span class="number">16</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span>: <span class="number">1.3862944</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;Y7TvEXIB8UFTVsLwtJkV&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">1.3862944</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">24</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;&lt;em&gt;张三&lt;/em&gt;&quot;</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="6-聚合aggregations"><a href="#6-聚合aggregations" class="headerlink" title="6. 聚合aggregations"></a>6. 聚合aggregations</h1><h2 id="6-1-基本概念"><a href="#6-1-基本概念" class="headerlink" title="6.1 基本概念"></a>6.1 基本概念</h2><p>Elasticsearch中的聚合，包含多种类型，最常用的两种，一个叫<code>桶</code>，一个叫<code>度量</code>：</p>
<blockquote>
<p><strong>桶（bucket）</strong></p>
</blockquote>
<p>桶的作用，是按照某种方式对数据进行分组，每一组数据在ES中称为一个<code>桶</code>，例如我们根据国籍对人划分，可以得到<code>中国桶</code>、<code>英国桶</code>，<code>日本桶</code>……或者我们按照年龄段对人进行划分：0<del>10,10</del>20,20<del>30,30</del>40等。</p>
<p>Elasticsearch中提供的划分桶的方式有很多：</p>
<ul>
<li>Date Histogram Aggregation：根据日期阶梯分组，例如给定阶梯为周，会自动每周分为一组</li>
<li>Histogram Aggregation：根据数值阶梯分组，与日期类似，需要知道分组的间隔（interval）</li>
<li>Terms Aggregation：根据词条内容分组，词条内容完全匹配的为一组</li>
<li>Range Aggregation：数值和日期的范围分组，指定开始和结束，然后按段分组</li>
<li>……</li>
</ul>
<p>综上所述，我们发现bucket aggregations 只负责对数据进行分组，并不进行计算，因此往往bucket中往往会嵌套另一种聚合：metrics aggregations即度量</p>
<blockquote>
<p><strong>度量（metrics）</strong></p>
</blockquote>
<p>分组完成以后，我们一般会对组中的数据进行聚合运算，例如求平均值、最大、最小、求和等，这些在ES中称为<code>度量</code></p>
<p>比较常用的一些度量聚合方式：</p>
<ul>
<li>Avg Aggregation：求平均值</li>
<li>Max Aggregation：求最大值</li>
<li>Min Aggregation：求最小值</li>
<li>Percentiles Aggregation：求百分比</li>
<li>Stats Aggregation：同时返回avg、max、min、sum、count等</li>
<li>Sum Aggregation：求和</li>
<li>Top hits Aggregation：求前几</li>
<li>Value Count Aggregation：求总数</li>
<li>……</li>
</ul>
<p>为了测试聚合，我们先批量导入一些数据</p>
<p>创建索引：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT /car</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;orders&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;color&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;make&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：在ES中，需要进行聚合、排序、过滤的字段其处理方式比较特殊，因此不能被分词，必须使用<code>keyword</code>或<code>数值类型</code>。这里我们将color和make这两个文字类型的字段设置为keyword类型，这个类型不会被分词，将来就可以参与聚合</p>
<p>导入数据:</p>
<p><img src="/2020/12/08/Elasticsearch/12.png"></p>
<h2 id="6-2-聚合为桶"><a href="#6-2-聚合为桶" class="headerlink" title="6.2 聚合为桶"></a>6.2 聚合为桶</h2><p>首先，我们按照 汽车的颜色<code>color来</code>划分<code>桶</code>，按照颜色分桶，最好是使用TermAggregation类型，按照颜色的名称来分桶。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /car/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;size&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span> : &#123; </span><br><span class="line">        <span class="attr">&quot;popular_colors&quot;</span> : &#123; </span><br><span class="line">            <span class="attr">&quot;terms&quot;</span> : &#123; </span><br><span class="line">              <span class="attr">&quot;field&quot;</span> : <span class="string">&quot;color&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>size： 查询条数，这里设置为0，因为我们不关心搜索到的数据，只关心聚合结果，提高效率</li>
<li>aggs：声明这是一个聚合查询，是aggregations的缩写<ul>
<li>popular_colors：给这次聚合起一个名字，可任意指定。<ul>
<li>terms：聚合的类型，这里选择terms，是根据词条内容（这里是颜色）划分<ul>
<li>field：划分桶时依赖的字段</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span>: <span class="number">83</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">8</span>,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: []</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;popular_colors&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;doc_count_error_upper_bound&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;sum_other_doc_count&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;buckets&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;红&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span>: <span class="number">4</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;绿&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span>: <span class="number">2</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;蓝&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span>: <span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>hits：查询结果为空，因为我们设置了size为0</li>
<li>aggregations：聚合的结果</li>
<li>popular_colors：我们定义的聚合名称</li>
<li>buckets：查找到的桶，每个不同的color字段值都会形成一个桶<ul>
<li>key：这个桶对应的color字段的值</li>
<li>doc_count：这个桶中的文档数量</li>
</ul>
</li>
</ul>
<h2 id="6-3-桶内度量"><a href="#6-3-桶内度量" class="headerlink" title="6.3 桶内度量"></a>6.3 桶内度量</h2><p>我们需要告诉Elasticsearch<code>使用哪个字段</code>，<code>使用何种度量方式</code>进行运算，这些信息要嵌套在<code>桶</code>内，<code>度量</code>的运算会基于<code>桶</code>内的文档进行</p>
<p>现在，我们为刚刚的聚合结果添加 求价格平均值的度量：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET /car/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;size&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span> : &#123; </span><br><span class="line">        <span class="attr">&quot;popular_colors&quot;</span> : &#123; </span><br><span class="line">            <span class="attr">&quot;terms&quot;</span> : &#123; </span><br><span class="line">              <span class="attr">&quot;field&quot;</span> : <span class="string">&quot;color&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;avg_price&quot;</span>: &#123; </span><br><span class="line">                   <span class="attr">&quot;avg&quot;</span>: &#123;</span><br><span class="line">                      <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span> </span><br><span class="line">                   &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>aggs：我们在上一个aggs(popular_colors)中添加新的aggs。可见度量也是一个聚合</li>
<li>avg_price：聚合的名称</li>
<li>avg：度量的类型，这里是求平均值</li>
<li>field：度量运算的字段</li>
</ul>
<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span>: <span class="number">12</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">8</span>,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: []</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;popular_colors&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;doc_count_error_upper_bound&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;sum_other_doc_count&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;buckets&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;红&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span>: <span class="number">4</span>,</span><br><span class="line">          <span class="attr">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="number">32500</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;绿&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="number">21000</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;蓝&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="number">20000</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到每个桶中都有自己的<code>avg_price</code>字段，这是度量聚合的结果</p>
<h1 id="7-Elasticsearch客户端"><a href="#7-Elasticsearch客户端" class="headerlink" title="7.Elasticsearch客户端"></a>7.Elasticsearch客户端</h1><h2 id="7-1-客户端介绍"><a href="#7-1-客户端介绍" class="headerlink" title="7.1.客户端介绍"></a>7.1.客户端介绍</h2><p>在elasticsearch官网中提供了各种语言的客户端：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/index.html">https://www.elastic.co/guide/en/elasticsearch/client/index.html</a></p>
<p><img src="/2020/12/08/Elasticsearch/13.png"></p>
<p>注意点击进入后，选择版本到<code>6.2</code>，因为我们之前按照的都是<code>6.2.4</code>版本</p>
<p>然后选择<code>Java High Level Rest Client</code>版本：</p>
<p><img src="/2020/12/08/Elasticsearch/1553651841987.png"></p>
<h2 id="7-2-创建Demo工程"><a href="#7-2-创建Demo工程" class="headerlink" title="7.2.创建Demo工程"></a>7.2.创建Demo工程</h2><p>1.搭建springboot的运行环境，导入依赖</p>
<p>2.通过单元测试的形式，学习ES的原生API操作服务器（<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/6.2/java-rest-high.html">Java High Level REST Client</a>）</p>
<p>3.在kibina中创建索引库，创建类型，创建映射关系</p>
<p>4.在java代码中创建一个操作的实体类对象</p>
<h2 id="7-3-索引库及映射"><a href="#7-3-索引库及映射" class="headerlink" title="7.3.索引库及映射"></a>7.3.索引库及映射</h2><p>创建索引库的同时，我们也会创建type及其映射关系，但是这些操作不建议使用java客户端完成，原因如下：</p>
<ul>
<li><p>索引库和映射往往是初始化时完成，不需要频繁操作，不如提前配置好</p>
</li>
<li><p>官方提供的创建索引库及映射API非常繁琐，需要通过字符串拼接json结构：</p>
<p><img src="/2020/12/08/Elasticsearch/1553654415047.png"></p>
</li>
</ul>
<p>我们接下来以这样一个物品数据为例来创建索引库：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.es.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String title; <span class="comment">//标题</span></span><br><span class="line">    <span class="keyword">private</span> String category;<span class="comment">// 分类</span></span><br><span class="line">    <span class="keyword">private</span> Double price; <span class="comment">// 价格 </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析一下数据结构：</p>
<ul>
<li>id：可以认为是主键，将来判断数据是否重复的标示，不分词，可以使用keyword类型</li>
<li>title：搜索字段，需要分词，可以用text类型</li>
<li>category：分类，这个是整体，不分词，可以使用keyword类型</li>
<li>price：价格，这个是double类型</li>
</ul>
<p>我们可以编写这样的映射配置：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PUT /item</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;docs&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;id&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;title&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;category&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;double&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-4-索引数据操作"><a href="#7-4-索引数据操作" class="headerlink" title="7.4.索引数据操作"></a>7.4.索引数据操作</h2><p>有了索引库，我们接下来看看如何新增索引数据</p>
<h3 id="7-4-0-初始化客户端"><a href="#7-4-0-初始化客户端" class="headerlink" title="7.4.0.初始化客户端"></a>7.4.0.初始化客户端</h3><p>完成任何操作都需要通过HighLevelRestClient客户端，我们先编写一个测试类</p>
<p>然后再@Before的方法中编写client初始化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Estest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient client;</span><br><span class="line">    <span class="comment">// Json工具</span></span><br><span class="line">    <span class="keyword">private</span> Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 初始化HighLevel客户端</span></span><br><span class="line">        client = <span class="keyword">new</span> RestHighLevelClient(</span><br><span class="line">                RestClient.builder(</span><br><span class="line">                        HttpHost.create(<span class="string">&quot;http://127.0.0.1:9200&quot;</span>)</span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 关闭客户端</span></span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-4-1-新增索引"><a href="#7-4-1-新增索引" class="headerlink" title="7.4.1.新增索引"></a>7.4.1.新增索引</h3><p><strong>kibana操作</strong></p>
<p><img src="/2020/12/08/Elasticsearch/1579225774814.png"></p>
<p><strong>java代码操作</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreateDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Item item = <span class="keyword">new</span> Item(<span class="number">9999L</span>, <span class="string">&quot;华为pro30手机&quot;</span>,<span class="string">&quot;手机&quot;</span>,<span class="number">5999.00</span>);</span><br><span class="line">    <span class="comment">//2.将对象转化为json</span></span><br><span class="line">    String source = gson.toJson(item);</span><br><span class="line">    <span class="comment">//3.构造一个新增文档的请求对象</span></span><br><span class="line">    IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(<span class="string">&quot;item&quot;</span>,<span class="string">&quot;docs&quot;</span>,item.getId().toString());</span><br><span class="line">    <span class="comment">//4.设置需要保存的数据</span></span><br><span class="line">    indexRequest.source(source, XContentType.JSON);</span><br><span class="line">    <span class="comment">//5.通过client执行请求对象</span></span><br><span class="line">    client.index(indexRequest, RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-4-2-查看索引"><a href="#7-4-2-查看索引" class="headerlink" title="7.4.2.查看索引"></a>7.4.2.查看索引</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="comment">//1.构造一个查询文档的请求对象</span></span><br><span class="line">	GetRequest getRequest = <span class="keyword">new</span> GetRequest(<span class="string">&quot;item&quot;</span>,<span class="string">&quot;docs&quot;</span>,<span class="string">&quot;9999&quot;</span>);</span><br><span class="line">	<span class="comment">//2.发送请求获取响应</span></span><br><span class="line">	GetResponse response = client.get(getRequest, RequestOptions.DEFAULT);</span><br><span class="line">	<span class="comment">//3.解析响应获取source数据</span></span><br><span class="line">	String source = response.getSourceAsString();</span><br><span class="line">	Item item = gson.fromJson(source, Item.class);</span><br><span class="line">	System.out.println(item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-4-3-修改索引"><a href="#7-4-3-修改索引" class="headerlink" title="7.4.3.修改索引"></a>7.4.3.修改索引</h3><p>新增时，如果传递的id是已经存在的，则会完成修改操作，如果不存在，则是修改。</p>
<h3 id="7-4-4-删除索引"><a href="#7-4-4-删除索引" class="headerlink" title="7.4.4.删除索引"></a>7.4.4.删除索引</h3><p>java操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="comment">//1.构造一个删除文档的请求对象</span></span><br><span class="line">	DeleteRequest deleteRequest = <span class="keyword">new</span> DeleteRequest(<span class="string">&quot;item&quot;</span>,<span class="string">&quot;docs&quot;</span>,<span class="string">&quot;9999&quot;</span>);</span><br><span class="line">	<span class="comment">//2.发送请求</span></span><br><span class="line">	client.delete(deleteRequest,RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-4-5-批量新增"><a href="#7-4-5-批量新增" class="headerlink" title="7.4.5.批量新增"></a>7.4.5.批量新增</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBulkIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    List&lt;Item&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    list.add(<span class="keyword">new</span> Item(<span class="number">1L</span>, <span class="string">&quot;小米手机7&quot;</span>, <span class="string">&quot;小米&quot;</span>, <span class="number">3299.00</span>));</span><br><span class="line">    list.add(<span class="keyword">new</span> Item(<span class="number">2L</span>, <span class="string">&quot;坚果手机R1&quot;</span>,  <span class="string">&quot;锤子&quot;</span>, <span class="number">3699.00</span>));</span><br><span class="line">    list.add(<span class="keyword">new</span> Item(<span class="number">3L</span>, <span class="string">&quot;华为META10&quot;</span>, <span class="string">&quot;华为&quot;</span>, <span class="number">4499.00</span>));</span><br><span class="line">    list.add(<span class="keyword">new</span> Item(<span class="number">4L</span>, <span class="string">&quot;小米Mix2S&quot;</span>,  <span class="string">&quot;小米&quot;</span>, <span class="number">4299.00</span>));</span><br><span class="line">    list.add(<span class="keyword">new</span> Item(<span class="number">5L</span>, <span class="string">&quot;荣耀V10&quot;</span>,  <span class="string">&quot;华为&quot;</span>, <span class="number">2799.00</span>));</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    BulkRequest request = <span class="keyword">new</span> BulkRequest();</span><br><span class="line">    <span class="keyword">for</span> (Item item : list) &#123;</span><br><span class="line">        request.add(<span class="keyword">new</span> IndexRequest(<span class="string">&quot;item&quot;</span>,<span class="string">&quot;docs&quot;</span>, item.getId().toString())</span><br><span class="line">                .source(gson.toJson(item), XContentType.JSON));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    BulkResponse response = client.bulk(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(<span class="string">&quot;response = &quot;</span> + response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键点：</p>
<ul>
<li>BulkRequest：批量请求，可以添加多个IndexRequest对象，完成批处理</li>
</ul>
<h2 id="7-5-搜索数据"><a href="#7-5-搜索数据" class="headerlink" title="7.5.搜索数据"></a>7.5.搜索数据</h2><h3 id="7-5-1-查询所有match-all"><a href="#7-5-1-查询所有match-all" class="headerlink" title="7.5.1.查询所有match_all"></a>7.5.1.查询所有match_all</h3><p>kibana操作</p>
<p><img src="/2020/12/08/Elasticsearch/1579227449897.png"></p>
<p>java代码操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMatchAll</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="comment">//1.构造一个查询请求对象 SearchRequest</span></span><br><span class="line">	SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;item&quot;</span>);</span><br><span class="line">	<span class="comment">//2.创建查询构造器 SearchSourceBuilder</span></span><br><span class="line">	SearchSourceBuilder builder = <span class="keyword">new</span> SearchSourceBuilder()</span><br><span class="line">			.query(QueryBuilders.matchAllQuery());</span><br><span class="line">	<span class="comment">//3.设置查询对象关系</span></span><br><span class="line">	searchRequest.source(builder);</span><br><span class="line">	<span class="comment">//4.发送请求，获取返回值</span></span><br><span class="line">	SearchResponse response = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">       <span class="comment">//5.解析</span></span><br><span class="line">	SearchHits hits = response.getHits();</span><br><span class="line">	SearchHit[] hits1 = hits.getHits();</span><br><span class="line">	<span class="keyword">for</span> (SearchHit documentFields : hits1) &#123;</span><br><span class="line">		<span class="comment">//获取每个hit对象中的_source字符串</span></span><br><span class="line">		String source = documentFields.getSourceAsString();</span><br><span class="line">		Item item = gson.fromJson(source,Item.class);</span><br><span class="line">		System.out.println(item);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>注意，上面的代码中，搜索条件是通过<code>sourceBuilder.query(QueryBuilders.matchAllQuery())</code>来添加的。这个<code>query()</code>方法接受的参数是：<code>QueryBuilder</code>接口类型。</p>
<p>这个接口提供了很多实现类，分别对应不同类型的查询，例如：term查询、match查询、range查询、boolean查询等，如图：</p>
<p><img src="/2020/12/08/Elasticsearch/1554348626154.png"> </p>
<p>因此，我们如果要使用各种不同查询，其实仅仅是传递给<code>sourceBuilder.query()</code>方法的参数不同而已。而这些实现类不需要我们去<code>new</code>，官方提供了<code>QueryBuilders</code>工厂帮我们构建各种实现类：</p>
<p><img src="/2020/12/08/Elasticsearch/1554348779338.png"> </p>
<h3 id="7-5-2-关键字搜索match"><a href="#7-5-2-关键字搜索match" class="headerlink" title="7.5.2.关键字搜索match"></a>7.5.2.关键字搜索match</h3><p>其实搜索类型的变化，仅仅是利用QueryBuilders构建的查询对象不同而已，其他代码基本一致：</p>
<p><img src="/2020/12/08/Elasticsearch/14.png"></p>
<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">共记录数：<span class="number">2</span></span><br><span class="line">Item&#123;id=<span class="number">2</span>, title=<span class="string">&#x27;坚果手机R1&#x27;</span>, category=<span class="string">&#x27;锤子&#x27;</span>, price=<span class="number">3699.0</span>&#125;</span><br><span class="line">Item&#123;id=<span class="number">1</span>, title=<span class="string">&#x27;小米手机7&#x27;</span>, category=<span class="string">&#x27;小米&#x27;</span>, price=<span class="number">3299.0</span>&#125;</span><br></pre></td></tr></table></figure>

<p>把这段代码封装，然后把查询条件作为参数传递：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">basicQuery</span><span class="params">(SearchSourceBuilder sourceBuilder)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SearchRequest request = <span class="keyword">new</span> SearchRequest();</span><br><span class="line">        request.source(sourceBuilder);</span><br><span class="line">        SearchResponse response = client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        SearchHits hits = response.getHits();</span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">            String json = hit.getSourceAsString();</span><br><span class="line">            Item item = gson.fromJson(json, Item.class);</span><br><span class="line">            System.out.println(<span class="string">&quot;item = &quot;</span> + item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-5-3-范围查询range"><a href="#7-5-3-范围查询range" class="headerlink" title="7.5.3.范围查询range"></a>7.5.3.范围查询range</h3><table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>gt(Object from)</td>
<td>大于</td>
</tr>
<tr>
<td>gte(Object from)</td>
<td>大于等于</td>
</tr>
<tr>
<td>lt(Object from)</td>
<td>小于</td>
</tr>
<tr>
<td>lte(Object from)</td>
<td>小于等于</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRangeQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    sourceBuilder.query(QueryBuilders.rangeQuery(<span class="string">&quot;price&quot;</span>).gt(<span class="number">1000</span>).lt(<span class="number">4000</span>));</span><br><span class="line">    basicQuery(sourceBuilder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">item = Item&#123;id=<span class="number">5</span>, title=<span class="string">&#x27;荣耀V10&#x27;</span>, category=<span class="string">&#x27;华为&#x27;</span>, price=<span class="number">2799.0</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">2</span>, title=<span class="string">&#x27;坚果手机R1&#x27;</span>, category=<span class="string">&#x27;锤子&#x27;</span>, price=<span class="number">3699.0</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">1</span>, title=<span class="string">&#x27;小米手机7&#x27;</span>, category=<span class="string">&#x27;小米&#x27;</span>, price=<span class="number">3299.0</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-5-4-source过滤"><a href="#7-5-4-source过滤" class="headerlink" title="7.5.4.source过滤"></a>7.5.4.source过滤</h3><p>默认情况下，索引库中所有数据都会返回，如果我们想只返回部分字段，可以通过source filter来控制。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSourceFilter</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加source过滤</span></span><br><span class="line">    sourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;id&quot;</span>, <span class="string">&quot;title&quot;</span>, <span class="string">&quot;price&quot;</span>&#125;, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    basicQuery(sourceBuilder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">item = Item&#123;id=<span class="number">5</span>, title=<span class="string">&#x27;荣耀V10&#x27;</span>, category=<span class="string">&#x27;null&#x27;</span>, price=<span class="number">2799.0</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">2</span>, title=<span class="string">&#x27;坚果手机R1&#x27;</span>, category=<span class="string">&#x27;null&#x27;</span>, price=<span class="number">3699.0</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">4</span>, title=<span class="string">&#x27;小米Mix2S&#x27;</span>, category=<span class="string">&#x27;null&#x27;</span>,price=<span class="number">4299.0</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">1</span>, title=<span class="string">&#x27;小米手机7&#x27;</span>, category=<span class="string">&#x27;null&#x27;</span>, price=<span class="number">3299.0</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">3</span>, title=<span class="string">&#x27;华为META10&#x27;</span>, category=<span class="string">&#x27;null&#x27;</span>, price=<span class="number">4499.0</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="7-6-排序"><a href="#7-6-排序" class="headerlink" title="7.6.排序"></a>7.6.排序</h2><p>依然是通过sourceBuilder来配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSortQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    SearchRequest request = <span class="keyword">new</span> SearchRequest();</span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line">    <span class="comment">// 添加排序</span></span><br><span class="line">    sourceBuilder.sort(<span class="string">&quot;price&quot;</span>, SortOrder.ASC);</span><br><span class="line"></span><br><span class="line">    basicQuery(sourceBuilder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">item = Item&#123;id=<span class="number">5</span>, title=<span class="string">&#x27;荣耀V10&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>,  price=<span class="number">2799.0</span> &#125;</span><br><span class="line">item = Item&#123;id=<span class="number">1</span>, title=<span class="string">&#x27;小米手机7&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, price=<span class="number">3299.0</span> &#125;</span><br><span class="line">item = Item&#123;id=<span class="number">2</span>, title=<span class="string">&#x27;坚果手机R1&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, price=<span class="number">3699.0</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">4</span>, title=<span class="string">&#x27;小米Mix2S&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, price=<span class="number">4299.0</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">3</span>, title=<span class="string">&#x27;华为META10&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, price=<span class="number">4499.0</span>, &#125;</span><br></pre></td></tr></table></figure>



<h2 id="7-7-分页"><a href="#7-7-分页" class="headerlink" title="7.7.分页"></a>7.7.分页</h2><p>分页需要视图层传递两个参数给我们：</p>
<ul>
<li>当前页：page</li>
<li>每页大小：size</li>
</ul>
<p>而elasticsearch中需要的不是当前页，而是起始位置，还好有公式可以计算出：</p>
<ul>
<li>起始位置：start = (page - 1) * size</li>
</ul>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSortAndPageQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SearchRequest request = <span class="keyword">new</span> SearchRequest();  </span><br><span class="line">        SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加排序</span></span><br><span class="line">        sourceBuilder.sort(<span class="string">&quot;price&quot;</span>, SortOrder.ASC);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加分页</span></span><br><span class="line">        <span class="keyword">int</span> page = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> size = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">int</span> start = (page - <span class="number">1</span>) * size;</span><br><span class="line"></span><br><span class="line">        sourceBuilder.from(start);</span><br><span class="line">        sourceBuilder.size(<span class="number">3</span>);</span><br><span class="line">        basicQuery(sourceBuilder);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">item = Item&#123;id=<span class="number">5</span>, title=<span class="string">&#x27;荣耀V10&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, price=<span class="number">2799.0</span>,&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">1</span>, title=<span class="string">&#x27;小米手机7&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>,  price=<span class="number">3299.0</span>, &#125;</span><br><span class="line">item = Item&#123;id=<span class="number">2</span>, title=<span class="string">&#x27;坚果手机R1&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, price=<span class="number">3699.0</span>, &#125;</span><br></pre></td></tr></table></figure>



<h2 id="7-8-聚合"><a href="#7-8-聚合" class="headerlink" title="7.8.聚合"></a>7.8.聚合</h2><p>再来试试聚合，我们这里以brand字段来聚合，看看有哪些品牌，每个品牌有多少数量。</p>
<p>聚合关键是弄清楚这几点：</p>
<ul>
<li>聚合的字段是什么</li>
<li>聚合的类型是什么</li>
<li>给聚合起个名</li>
</ul>
<p>与查询类似，聚合条件通过<code>sourceBuilder.aggregation()</code>方法来设置，而参数是一个接口：<code>AggregationBuilder</code>，这个接口也有大量的实现类，代表不同的聚合种类：</p>
<p><img src="/2020/12/08/Elasticsearch/1554349744329.png"> </p>
<p>同样，我们也不需要自己去new，官方提供了一个工厂帮我们创建实例：</p>
<p><img src="/2020/12/08/Elasticsearch/1554349849946.png"> </p>
<p>代码示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAggregation</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    SearchRequest request = <span class="keyword">new</span> SearchRequest();</span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line">    sourceBuilder.sort(<span class="string">&quot;price&quot;</span>, SortOrder.ASC);</span><br><span class="line">    <span class="comment">// 配置size为0，因为不需要数据，只要聚合结果</span></span><br><span class="line">    sourceBuilder.size(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加聚合</span></span><br><span class="line">    sourceBuilder.aggregation(AggregationBuilders.terms(<span class="string">&quot;categoryAgg&quot;</span>).field(<span class="string">&quot;category&quot;</span>));</span><br><span class="line">    request.source(sourceBuilder);</span><br><span class="line">    </span><br><span class="line">    SearchResponse response = client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    Aggregations aggregations = response.getAggregations();</span><br><span class="line">    Terms terms = aggregations.get(<span class="string">&quot;categoryAgg&quot;</span>);</span><br><span class="line">    <span class="comment">// 获取桶</span></span><br><span class="line">    <span class="keyword">for</span> (Terms.Bucket bucket : terms.getBuckets()) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;分类 : &quot;</span> + bucket.getKeyAsString());</span><br><span class="line">        System.out.println(<span class="string">&quot;count: &quot;</span> + bucket.getDocCount());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">分类 : 华为</span><br><span class="line">count: <span class="number">2</span></span><br><span class="line">分类 : 小米</span><br><span class="line">count: <span class="number">2</span></span><br><span class="line">分类 : 锤子</span><br><span class="line">count: <span class="number">1</span></span><br></pre></td></tr></table></figure>



<h2 id="7-9-高亮"><a href="#7-9-高亮" class="headerlink" title="7.9.高亮"></a>7.9.高亮</h2><p>代码示例：</p>
<p><img src="/2020/12/08/Elasticsearch/15.png"></p>
<p>关键代码：</p>
<ul>
<li>查询条件中添加高亮字段：<ul>
<li><code>new HighlightBuilder()</code>：创建高亮构建器</li>
<li><code>.field(&quot;title&quot;)</code>：指定高亮字段</li>
<li><code>.preTags(&quot;&quot;)</code>和<code>.postTags(&quot;&quot;)</code>：指定高亮的前置和后置标签</li>
</ul>
</li>
</ul>
<h1 id="8-SpringDataElasticsearch"><a href="#8-SpringDataElasticsearch" class="headerlink" title="8.SpringDataElasticsearch"></a>8.SpringDataElasticsearch</h1><p>1.搭建springboot运行环境，导入SpringDataElasticsearch起步依赖</p>
<p>2.配置application.yml 。配置Elasticsearch服务器的节点请求路径</p>
<p>3.配置实体类，通过注解的形式配置实体类和服务器的关系(@document,@Id,@FIeld)</p>
<p>4.可以通过内置ElasticsearchTemplate对象操作（创建索引库，创建type和mapping）</p>
<p>5.对于基本CRUD（编写一个接口继承父接口ElasticsearchRepostitory）,调用接口中的完成完成</p>
<p>6.自定义方法查询：findBy属性名+查询方式（=可以省略）</p>
<p>7.可以使用本地方法NativeSearchQueryBuilder</p>
<h2 id="8-1-什么是SpringDataElasticsearch"><a href="#8-1-什么是SpringDataElasticsearch" class="headerlink" title="8.1.什么是SpringDataElasticsearch"></a>8.1.什么是SpringDataElasticsearch</h2><p>SpringDataElasticsearch（以后简称SDE）是Spring Data项目下的一个子模块。</p>
<p>查看 Spring Data的官网：<a target="_blank" rel="noopener" href="http://projects.spring.io/spring-data/">http://projects.spring.io/spring-data/</a></p>
<p><img src="/2020/12/08/Elasticsearch/1526539628841.png"> </p>
<p>Spring Data 的使命是给各种数据访问提供统一的编程接口，不管是关系型数据库（如MySQL），还是非关系数据库（如Redis），或者类似Elasticsearch这样的索引数据库。从而简化开发人员的代码，提高开发效率。</p>
<p>包含很多不同数据操作的模块：</p>
<p><img src="/2020/12/08/Elasticsearch/1526539880872.png"> </p>
<p>Spring Data Elasticsearch的页面：<a target="_blank" rel="noopener" href="https://projects.spring.io/spring-data-elasticsearch/">https://projects.spring.io/spring-data-elasticsearch/</a></p>
<p><img src="/2020/12/08/Elasticsearch/1526540053252.png"> </p>
<p>特征：</p>
<ul>
<li>支持Spring的基于<code>@Configuration</code>的java配置方式，或者XML配置方式</li>
<li>提供了用于操作ES的便捷工具类**<code>ElasticsearchTemplate</code>**。包括实现文档到POJO之间的自动智能映射。</li>
<li>利用Spring的数据转换服务实现的功能丰富的对象映射</li>
<li>基于注解的元数据映射方式，而且可扩展以支持更多不同的数据格式</li>
<li>根据持久层接口自动生成对应实现方法，无需人工编写基本操作代码（类似mybatis，根据接口自动得到实现）。当然，也支持人工定制查询</li>
</ul>
<h2 id="8-2-配置SpringDataElasticsearch"><a href="#8-2-配置SpringDataElasticsearch" class="headerlink" title="8.2.配置SpringDataElasticsearch"></a>8.2.配置SpringDataElasticsearch</h2><p><strong>1.搭建springboot运行环境，导入SpringDataElasticsearch的起步依赖</strong></p>
<p><strong>2.在appication.yml中配置Elasticsearch服务器路径（只支持tcp协议）</strong></p>
<p><strong>3.创建一个实体类</strong></p>
<p><strong>4.通过springdata提供对象 ElasticsearchTemplate完成索引和映射等的操作</strong></p>
<p>需要注意的是，SpringDataElasticsearch底层使用的不是Elasticsearch提供的RestHighLevelClient，而是TransportClient，并不采用Http协议通信，而是访问elasticsearch对外开放的tcp端口，我们之前集群配置中，设置的分别是：9300</p>
<h2 id="8-3-索引数据CRUD"><a href="#8-3-索引数据CRUD" class="headerlink" title="8.3.索引数据CRUD"></a>8.3.索引数据CRUD</h2><p>SDE的索引数据CRUD并没有封装在ElasticsearchTemplate中，而是有一个叫做ElasticsearchRepository的接口：</p>
<p><img src="/2020/12/08/Elasticsearch/1554378139181.png"> </p>
<p>我们需要自定义接口，继承ElasticsearchRespository：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.es.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.es.pojo.Item;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.repository.ElasticsearchRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Itemrepository</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">Item</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-3-1-创建索引数据"><a href="#8-3-1-创建索引数据" class="headerlink" title="8.3.1.创建索引数据"></a>8.3.1.创建索引数据</h3><p>创建索引有单个创建和批量创建之分，先来看单个创建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> GoodsRepository goodsRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDocument</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Item item = <span class="keyword">new</span> Item(<span class="number">1L</span>, <span class="string">&quot;小米手机9&quot;</span>, <span class="string">&quot; 手机&quot;</span>,</span><br><span class="line">                 <span class="number">3499.00</span>);</span><br><span class="line">        <span class="comment">// 添加索引数据</span></span><br><span class="line">        itemrepository.save(item);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>再来看批量创建：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDocuments</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 准备文档数据：</span></span><br><span class="line">    List&lt;Item&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    list.add(<span class="keyword">new</span> Item(<span class="number">1L</span>, <span class="string">&quot;小米手机7&quot;</span>, <span class="string">&quot;手机&quot;</span>,  <span class="number">3299.00</span>));</span><br><span class="line">    list.add(<span class="keyword">new</span> Item(<span class="number">2L</span>, <span class="string">&quot;坚果手机R1&quot;</span>, <span class="string">&quot;手机&quot;</span>,  <span class="number">3699.00</span>));</span><br><span class="line">    list.add(<span class="keyword">new</span> Item(<span class="number">3L</span>, <span class="string">&quot;华为META10&quot;</span>, <span class="string">&quot;手机&quot;</span>,  <span class="number">4499.00</span>));</span><br><span class="line">    list.add(<span class="keyword">new</span> Item(<span class="number">4L</span>, <span class="string">&quot;小米Mix2S&quot;</span>, <span class="string">&quot;手机&quot;</span>,  <span class="number">4299.00</span>));</span><br><span class="line">    list.add(<span class="keyword">new</span> Item(<span class="number">5L</span>, <span class="string">&quot;荣耀V10&quot;</span>, <span class="string">&quot;手机&quot;</span>,  <span class="number">2799.00</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加索引数据</span></span><br><span class="line">    itemrepository.saveAll(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过elasticsearch-head查看：</p>
<p><img src="/2020/12/08/Elasticsearch/16.png"></p>
<h3 id="8-4-2-查询索引数据"><a href="#8-4-2-查询索引数据" class="headerlink" title="8.4.2.查询索引数据"></a>8.4.2.查询索引数据</h3><p>默认提供了根据id查询，查询所有两个功能：</p>
<blockquote>
<p>根据id查询</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryById</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Optional&lt;Item&gt; goodsOptional = itemrepository.findById(<span class="number">3L</span>);</span><br><span class="line">    System.out.println(goodsOptional.orElse(<span class="keyword">null</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Item&#123;id=<span class="number">3</span>, title=<span class="string">&#x27;华为META10&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, price=<span class="number">4499.0</span>&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>查询所有：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryAll</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Iterable&lt;Item&gt; list = itemrepository.findAll();</span><br><span class="line">    list.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Item&#123;id&#x3D;2, title&#x3D;&#39;坚果手机R1&#39;, category&#x3D;&#39;手机&#39;, price&#x3D;3699.0&#125;</span><br><span class="line">Item&#123;id&#x3D;4, title&#x3D;&#39;小米Mix2S&#39;, category&#x3D;&#39;手机&#39;, price&#x3D;4299.0&#125;</span><br><span class="line">Item&#123;id&#x3D;5, title&#x3D;&#39;荣耀V10&#39;, category&#x3D;&#39;手机&#39;, price&#x3D;2799.0&#125;</span><br><span class="line">Item&#123;id&#x3D;1, title&#x3D;&#39;小米手机7&#39;, category&#x3D;&#39;手机&#39;, price&#x3D;3299.0&#125;</span><br><span class="line">Item&#123;id&#x3D;3, title&#x3D;&#39;华为META10&#39;, category&#x3D;&#39;手机&#39;, price&#x3D;4499.0&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="8-4-3-自定义方法查询"><a href="#8-4-3-自定义方法查询" class="headerlink" title="8.4.3.自定义方法查询"></a>8.4.3.自定义方法查询</h3><p>ItemRepository提供的查询方法有限，但是它却提供了非常强大的自定义查询功能：</p>
<p>只要遵循SpringData提供的语法，我们可以任意定义方法声明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Itemrepository</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">Item</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据价格区间查询</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Item&gt; <span class="title">findByPriceBetween</span><span class="params">(Double from, Double to)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>无需写实现，SDE会自动帮我们实现该方法，我们只需要用即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryByPrice</span><span class="params">()</span></span>&#123;</span><br><span class="line">    List&lt;Item&gt; list = itemrepository.findByPriceBetween(<span class="number">1000d</span>, <span class="number">4000d</span>);</span><br><span class="line">    list.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Item&#123;id&#x3D;2, title&#x3D;&#39;坚果手机R1&#39;, category&#x3D;&#39;手机&#39;,  price&#x3D;3699.0&#125;</span><br><span class="line">Item&#123;id&#x3D;5, title&#x3D;&#39;荣耀V10&#39;, category&#x3D;&#39;手机&#39;,  price&#x3D;2799.0&#125;</span><br><span class="line">Item&#123;id&#x3D;1, title&#x3D;&#39;小米手机7&#39;, category&#x3D;&#39;手机&#39;, price&#x3D;3299.0&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>支持的一些语法示例：</p>
<table>
<thead>
<tr>
<th>Keyword</th>
<th>Sample</th>
<th>Elasticsearch Query String</th>
</tr>
</thead>
<tbody><tr>
<td><code>And</code></td>
<td><code>findByNameAndPrice</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : [ &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;, &#123;&quot;field&quot; : &#123;&quot;price&quot; : &quot;?&quot;&#125;&#125; ]&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Or</code></td>
<td><code>findByNameOrPrice</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;should&quot; : [ &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;, &#123;&quot;field&quot; : &#123;&quot;price&quot; : &quot;?&quot;&#125;&#125; ]&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Is</code></td>
<td><code>findByName</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Not</code></td>
<td><code>findByNameNot</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must_not&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Between</code></td>
<td><code>findByPriceBetween</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : ?,&quot;to&quot; : ?,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>LessThanEqual</code></td>
<td><code>findByPriceLessThan</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : null,&quot;to&quot; : ?,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>GreaterThanEqual</code></td>
<td><code>findByPriceGreaterThan</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : ?,&quot;to&quot; : null,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Before</code></td>
<td><code>findByPriceBefore</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : null,&quot;to&quot; : ?,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>After</code></td>
<td><code>findByPriceAfter</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : ?,&quot;to&quot; : null,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Like</code></td>
<td><code>findByNameLike</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;?*&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>StartingWith</code></td>
<td><code>findByNameStartingWith</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;?*&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>EndingWith</code></td>
<td><code>findByNameEndingWith</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;*?&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Contains/Containing</code></td>
<td><code>findByNameContaining</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;**?**&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>In</code></td>
<td><code>findByNameIn(Collection&lt;String&gt;names)</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;bool&quot; : &#123;&quot;should&quot; : [ &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;, &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125; ]&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>NotIn</code></td>
<td><code>findByNameNotIn(Collection&lt;String&gt;names)</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must_not&quot; : &#123;&quot;bool&quot; : &#123;&quot;should&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Near</code></td>
<td><code>findByStoreNear</code></td>
<td><code>Not Supported Yet !</code></td>
</tr>
<tr>
<td><code>True</code></td>
<td><code>findByAvailableTrue</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;available&quot; : true&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>False</code></td>
<td><code>findByAvailableFalse</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;available&quot; : false&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>OrderBy</code></td>
<td><code>findByAvailableTrueOrderByNameDesc</code></td>
<td><code>&#123;&quot;sort&quot; : [&#123; &quot;name&quot; : &#123;&quot;order&quot; : &quot;desc&quot;&#125; &#125;],&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;available&quot; : true&#125;&#125;&#125;&#125;</code></td>
</tr>
</tbody></table>
<h2 id="8-5-原生查询"><a href="#8-5-原生查询" class="headerlink" title="8.5.原生查询"></a>8.5.原生查询</h2><p>如果觉得上述接口依然不符合你的需求，SDE也支持原生查询，这个时候还是使用ElasticsearchTemplate</p>
<p>而查询条件的构建是通过一个名为<code>NativeSearchQueryBuilder</code>的类来完成的，不过这个类的底层还是使用的原生API中的<code>QueryBuilders</code>、<code>AggregationBuilders</code>、<code>HighlightBuilders</code>等工具。</p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchTemplate elasticsearchTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.创建NativeSearchQueryBuilder</span></span><br><span class="line">        NativeSearchQueryBuilder builder = <span class="keyword">new</span> NativeSearchQueryBuilder();</span><br><span class="line">        <span class="comment">//2.设置条件</span></span><br><span class="line"><span class="comment">//        builder.withQuery(QueryBuilders.matchAllQuery()); //查询全部</span></span><br><span class="line"><span class="comment">//        builder.withQuery(QueryBuilders.matchQuery(&quot;title&quot;,&quot;小米手机&quot;)); //match查询</span></span><br><span class="line">        builder.withQuery(QueryBuilders.rangeQuery(<span class="string">&quot;price&quot;</span>).lte(<span class="number">3000</span>).gte(<span class="number">1000</span>)); <span class="comment">//范围查询</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.调用elasticsearchTemplate的方法完成操作</span></span><br><span class="line">        List&lt;Item&gt; list = elasticsearchTemplate.queryForList(builder.build(), Item.class);</span><br><span class="line">        <span class="keyword">for</span> (Item item : list) &#123;</span><br><span class="line">            System.out.println(item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	    <span class="comment">//排序和分页</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.创建NativeSearchQueryBuilder</span></span><br><span class="line">        NativeSearchQueryBuilder builder = <span class="keyword">new</span> NativeSearchQueryBuilder();</span><br><span class="line">        <span class="comment">//2.设置条件</span></span><br><span class="line">        builder.withQuery(QueryBuilders.matchAllQuery());</span><br><span class="line">        builder.withSort(SortBuilders.fieldSort(<span class="string">&quot;price&quot;</span>).order(SortOrder.DESC));<span class="comment">//排序</span></span><br><span class="line">        <span class="comment">//设置分页参数</span></span><br><span class="line">        builder.withPageable(PageRequest.of(<span class="number">1</span>,<span class="number">2</span>)) ;<span class="comment">//封装所有的分页数据 </span></span><br><span class="line">        AggregatedPage&lt;Item&gt; pageBean = elasticsearchTemplate.queryForPage(builder.build(), Item.class);</span><br><span class="line">        List&lt;Item&gt; content = pageBean.getContent(); <span class="comment">//当前页的所有数据列表</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Item item : content) &#123;</span><br><span class="line">            System.out.println(item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>上述查询不支持高亮结果。</p>
<h2 id="8-6-聚合查询"><a href="#8-6-聚合查询" class="headerlink" title="8.6 聚合查询"></a>8.6 聚合查询</h2><p><strong>kibana操作</strong></p>
<p><img src="/2020/12/08/Elasticsearch/17.png"></p>
<p><strong>java代码操作</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">testAgg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        NativeSearchQueryBuilder builder = <span class="keyword">new</span> NativeSearchQueryBuilder();</span><br><span class="line">        builder.addAggregation(AggregationBuilders.terms(<span class="string">&quot;aggs-category&quot;</span>).field(<span class="string">&quot;category&quot;</span>));</span><br><span class="line">        <span class="comment">//3.执行</span></span><br><span class="line">        AggregatedPage&lt;Item&gt; page = elasticsearchTemplate.queryForPage(builder.build(), Item.class);</span><br><span class="line">        <span class="comment">//4.解析查询数据结果，获取统计数据</span></span><br><span class="line">        Aggregations aggregations = page.getAggregations();</span><br><span class="line">        Terms terms = aggregations.get(<span class="string">&quot;aggs-category&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//桶</span></span><br><span class="line">        List&lt;? extends Terms.Bucket&gt; list = terms.getBuckets();</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket bucket : list) &#123;</span><br><span class="line">            System.out.println(bucket.getKeyAsString()+<span class="string">&quot;-----&gt;&quot;</span>+bucket.getDocCount());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Hannibal</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://liwenchang.ren/2020/12/08/Elasticsearch/">http://liwenchang.ren/2020/12/08/Elasticsearch/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://liwenchang.ren" target="_blank">木子文昍</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%99%E7%A8%8B/">教程</a><a class="post-meta__tags" href="/tags/%E7%B4%A2%E5%BC%95%E5%BA%93/">索引库</a><a class="post-meta__tags" href="/tags/kibana/">kibana</a><a class="post-meta__tags" href="/tags/SpringDataElasticsearch/">SpringDataElasticsearch</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2020/12/08/MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MySQL性能优化</div></div></a></div></nav></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/null" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Hannibal</div><div class="author-info__description">虽不能至，心向往之</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">26</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Elasticsearch%E4%BB%8B%E7%BB%8D%E5%92%8C%E5%AE%89%E8%A3%85"><span class="toc-number">1.</span> <span class="toc-text">1.Elasticsearch介绍和安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">1.1.简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1.1 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2-%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E6%AF%94"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.1.2 与数据库对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E5%AE%89%E8%A3%85Elasticsearch"><span class="toc-number">1.2.</span> <span class="toc-text">1.2.安装Elasticsearch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E5%AE%89%E8%A3%85kibana"><span class="toc-number">1.3.</span> <span class="toc-text">1.3.安装kibana</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1-%E4%BB%80%E4%B9%88%E6%98%AFKibana"><span class="toc-number">1.3.1.</span> <span class="toc-text">1.3.1.什么是Kibana</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-2-%E5%AE%89%E8%A3%85"><span class="toc-number">1.3.2.</span> <span class="toc-text">1.3.2.安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-3-%E9%85%8D%E7%BD%AE%E8%BF%90%E8%A1%8C"><span class="toc-number">1.3.3.</span> <span class="toc-text">1.3.3.配置运行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-4-%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="toc-number">1.3.4.</span> <span class="toc-text">1.3.4.控制台</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E5%AE%89%E8%A3%85ik%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">1.4.</span> <span class="toc-text">1.4 安装ik分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-1-%E5%AE%89%E8%A3%85"><span class="toc-number">1.4.1.</span> <span class="toc-text">1.4.1.安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-2-%E6%B5%8B%E8%AF%95"><span class="toc-number">1.4.2.</span> <span class="toc-text">1.5.2.测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8kibana%E5%AF%B9%E7%B4%A2%E5%BC%95%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="toc-number">2.</span> <span class="toc-text">2.使用kibana对索引库操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">2.1.</span> <span class="toc-text">2.1.基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-number">2.2.</span> <span class="toc-text">2.2.创建索引库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-%E8%AF%AD%E6%B3%95"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1.语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-%E4%BD%BF%E7%94%A8kibana%E5%88%9B%E5%BB%BA"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2.使用kibana创建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-number">2.3.</span> <span class="toc-text">2.3.查看索引库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-number">2.4.</span> <span class="toc-text">2.4.删除索引库</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E4%BD%BF%E7%94%A8kibana%E5%AF%B9%E7%B1%BB%E5%9E%8B%E5%8F%8A%E6%98%A0%E5%B0%84%E6%93%8D%E4%BD%9C"><span class="toc-number">3.</span> <span class="toc-text">3.使用kibana对类型及映射操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E5%88%9B%E5%BB%BA%E5%AD%97%E6%AE%B5%E6%98%A0%E5%B0%84"><span class="toc-number">3.1.</span> <span class="toc-text">3.1.创建字段映射</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E6%9F%A5%E7%9C%8B%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BB"><span class="toc-number">3.2.</span> <span class="toc-text">3.2.查看映射关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E6%98%A0%E5%B0%84%E5%B1%9E%E6%80%A7%E8%AF%A6%E8%A7%A3"><span class="toc-number">3.3.</span> <span class="toc-text">3.3.映射属性详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89type"><span class="toc-number">3.3.0.1.</span> <span class="toc-text">1）type</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89index"><span class="toc-number">3.3.0.2.</span> <span class="toc-text">2）index</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89store"><span class="toc-number">3.3.0.3.</span> <span class="toc-text">3）store</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%EF%BC%89boost"><span class="toc-number">3.3.0.4.</span> <span class="toc-text">4）boost</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E4%B8%80%E6%AC%A1%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93%E5%92%8C%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.4.</span> <span class="toc-text">3.4.一次创建索引库和类型</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E4%BD%BF%E7%94%A8kibana%E5%AF%B9%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C"><span class="toc-number">4.</span> <span class="toc-text">4.使用kibana对文档操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E6%96%B0%E5%A2%9E%E6%96%87%E6%A1%A3"><span class="toc-number">4.1.</span> <span class="toc-text">4.1.新增文档</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E6%96%B0%E5%A2%9E%E5%B9%B6%E9%9A%8F%E6%9C%BA%E7%94%9F%E6%88%90id"><span class="toc-number">4.1.1.</span> <span class="toc-text">4.1.1 新增并随机生成id</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-%E6%96%B0%E5%A2%9E%E6%96%87%E6%A1%A3%E5%B9%B6%E8%87%AA%E5%AE%9A%E4%B9%89id"><span class="toc-number">4.1.2.</span> <span class="toc-text">4.1.2 新增文档并自定义id</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E6%9F%A5%E7%9C%8B%E6%96%87%E6%A1%A3"><span class="toc-number">4.2.</span> <span class="toc-text">4.2.查看文档</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE"><span class="toc-number">4.3.</span> <span class="toc-text">4.3.修改数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE"><span class="toc-number">4.4.</span> <span class="toc-text">4.4.删除数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-%E6%99%BA%E8%83%BD%E5%88%A4%E6%96%AD"><span class="toc-number">4.5.</span> <span class="toc-text">4.5.智能判断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6-%E5%8A%A8%E6%80%81%E6%98%A0%E5%B0%84%E6%A8%A1%E6%9D%BF"><span class="toc-number">4.6.</span> <span class="toc-text">4.6.动态映射模板</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-kibana%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="toc-number">5.</span> <span class="toc-text">5.kibana查询文档</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2"><span class="toc-number">5.1.</span> <span class="toc-text">5.1.基本查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-1-%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%EF%BC%88match-all"><span class="toc-number">5.1.1.</span> <span class="toc-text">5.1.1 查询所有（match_all)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-2-%E5%8C%B9%E9%85%8D%E6%9F%A5%E8%AF%A2%EF%BC%88match%EF%BC%89"><span class="toc-number">5.1.2.</span> <span class="toc-text">5.1.2 匹配查询（match）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-3-%E8%AF%8D%E6%9D%A1%E5%8C%B9%E9%85%8D-term"><span class="toc-number">5.1.3.</span> <span class="toc-text">5.1.3 词条匹配(term)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-4-%E5%B8%83%E5%B0%94%E7%BB%84%E5%90%88%EF%BC%88bool"><span class="toc-number">5.1.4.</span> <span class="toc-text">5.1.4 布尔组合（bool)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-5-%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2-range"><span class="toc-number">5.1.5.</span> <span class="toc-text">5.1.5 范围查询(range)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-6-%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2-fuzzy"><span class="toc-number">5.1.6.</span> <span class="toc-text">5.1.6 模糊查询(fuzzy)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E7%BB%93%E6%9E%9C%E8%BF%87%E6%BB%A4"><span class="toc-number">5.2.</span> <span class="toc-text">5.2.结果过滤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-%E7%9B%B4%E6%8E%A5%E6%8C%87%E5%AE%9A%E5%AD%97%E6%AE%B5"><span class="toc-number">5.2.1.</span> <span class="toc-text">5.2.1.直接指定字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-%E6%8C%87%E5%AE%9Aincludes%E5%92%8Cexcludes"><span class="toc-number">5.2.2.</span> <span class="toc-text">5.2.2.指定includes和excludes</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E6%8E%92%E5%BA%8F"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 排序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-1-%E5%8D%95%E5%AD%97%E6%AE%B5%E6%8E%92%E5%BA%8F"><span class="toc-number">5.3.1.</span> <span class="toc-text">5.3.1 单字段排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-2-%E5%A4%9A%E5%AD%97%E6%AE%B5%E6%8E%92%E5%BA%8F"><span class="toc-number">5.3.2.</span> <span class="toc-text">5.3.2 多字段排序</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E5%88%86%E9%A1%B5"><span class="toc-number">5.4.</span> <span class="toc-text">5.4.分页</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-%E9%AB%98%E4%BA%AE"><span class="toc-number">5.5.</span> <span class="toc-text">5.5.高亮</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E8%81%9A%E5%90%88aggregations"><span class="toc-number">6.</span> <span class="toc-text">6. 聚合aggregations</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E8%81%9A%E5%90%88%E4%B8%BA%E6%A1%B6"><span class="toc-number">6.2.</span> <span class="toc-text">6.2 聚合为桶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E6%A1%B6%E5%86%85%E5%BA%A6%E9%87%8F"><span class="toc-number">6.3.</span> <span class="toc-text">6.3 桶内度量</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-Elasticsearch%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">7.</span> <span class="toc-text">7.Elasticsearch客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%8B%E7%BB%8D"><span class="toc-number">7.1.</span> <span class="toc-text">7.1.客户端介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-%E5%88%9B%E5%BB%BADemo%E5%B7%A5%E7%A8%8B"><span class="toc-number">7.2.</span> <span class="toc-text">7.2.创建Demo工程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-%E7%B4%A2%E5%BC%95%E5%BA%93%E5%8F%8A%E6%98%A0%E5%B0%84"><span class="toc-number">7.3.</span> <span class="toc-text">7.3.索引库及映射</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4-%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C"><span class="toc-number">7.4.</span> <span class="toc-text">7.4.索引数据操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-0-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">7.4.1.</span> <span class="toc-text">7.4.0.初始化客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-1-%E6%96%B0%E5%A2%9E%E7%B4%A2%E5%BC%95"><span class="toc-number">7.4.2.</span> <span class="toc-text">7.4.1.新增索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-2-%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95"><span class="toc-number">7.4.3.</span> <span class="toc-text">7.4.2.查看索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-3-%E4%BF%AE%E6%94%B9%E7%B4%A2%E5%BC%95"><span class="toc-number">7.4.4.</span> <span class="toc-text">7.4.3.修改索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-4-%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="toc-number">7.4.5.</span> <span class="toc-text">7.4.4.删除索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-5-%E6%89%B9%E9%87%8F%E6%96%B0%E5%A2%9E"><span class="toc-number">7.4.6.</span> <span class="toc-text">7.4.5.批量新增</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-5-%E6%90%9C%E7%B4%A2%E6%95%B0%E6%8D%AE"><span class="toc-number">7.5.</span> <span class="toc-text">7.5.搜索数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-1-%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89match-all"><span class="toc-number">7.5.1.</span> <span class="toc-text">7.5.1.查询所有match_all</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-2-%E5%85%B3%E9%94%AE%E5%AD%97%E6%90%9C%E7%B4%A2match"><span class="toc-number">7.5.2.</span> <span class="toc-text">7.5.2.关键字搜索match</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-3-%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2range"><span class="toc-number">7.5.3.</span> <span class="toc-text">7.5.3.范围查询range</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-4-source%E8%BF%87%E6%BB%A4"><span class="toc-number">7.5.4.</span> <span class="toc-text">7.5.4.source过滤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-6-%E6%8E%92%E5%BA%8F"><span class="toc-number">7.6.</span> <span class="toc-text">7.6.排序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-7-%E5%88%86%E9%A1%B5"><span class="toc-number">7.7.</span> <span class="toc-text">7.7.分页</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-8-%E8%81%9A%E5%90%88"><span class="toc-number">7.8.</span> <span class="toc-text">7.8.聚合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-9-%E9%AB%98%E4%BA%AE"><span class="toc-number">7.9.</span> <span class="toc-text">7.9.高亮</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-SpringDataElasticsearch"><span class="toc-number">8.</span> <span class="toc-text">8.SpringDataElasticsearch</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-%E4%BB%80%E4%B9%88%E6%98%AFSpringDataElasticsearch"><span class="toc-number">8.1.</span> <span class="toc-text">8.1.什么是SpringDataElasticsearch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-%E9%85%8D%E7%BD%AESpringDataElasticsearch"><span class="toc-number">8.2.</span> <span class="toc-text">8.2.配置SpringDataElasticsearch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AECRUD"><span class="toc-number">8.3.</span> <span class="toc-text">8.3.索引数据CRUD</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-1-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE"><span class="toc-number">8.3.1.</span> <span class="toc-text">8.3.1.创建索引数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-2-%E6%9F%A5%E8%AF%A2%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE"><span class="toc-number">8.3.2.</span> <span class="toc-text">8.4.2.查询索引数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-3-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%B9%E6%B3%95%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.3.3.</span> <span class="toc-text">8.4.3.自定义方法查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-5-%E5%8E%9F%E7%94%9F%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.4.</span> <span class="toc-text">8.5.原生查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-6-%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.5.</span> <span class="toc-text">8.6 聚合查询</span></a></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2020/12/08/Elasticsearch/" title="Elasticsearch"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Elasticsearch"/></a><div class="content"><a class="title" href="/2020/12/08/Elasticsearch/" title="Elasticsearch">Elasticsearch</a><time datetime="2020-12-08T08:57:03.000Z" title="发表于 2020-12-08 16:57:03">2020-12-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/08/MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" title="MySQL性能优化"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL性能优化"/></a><div class="content"><a class="title" href="/2020/12/08/MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" title="MySQL性能优化">MySQL性能优化</a><time datetime="2020-12-08T08:38:09.000Z" title="发表于 2020-12-08 16:38:09">2020-12-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/03/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9F%A5%E8%AF%86%E7%82%B9/" title="多线程知识点"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="多线程知识点"/></a><div class="content"><a class="title" href="/2020/12/03/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9F%A5%E8%AF%86%E7%82%B9/" title="多线程知识点">多线程知识点</a><time datetime="2020-12-03T11:49:40.000Z" title="发表于 2020-12-03 19:49:40">2020-12-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/03/SpringCloud%E7%9F%A5%E8%AF%86%E7%82%B9/" title="SpringCloud知识点"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SpringCloud知识点"/></a><div class="content"><a class="title" href="/2020/12/03/SpringCloud%E7%9F%A5%E8%AF%86%E7%82%B9/" title="SpringCloud知识点">SpringCloud知识点</a><time datetime="2020-12-03T11:49:25.000Z" title="发表于 2020-12-03 19:49:25">2020-12-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/03/spring%E7%9F%A5%E8%AF%86%E7%82%B9/" title="spring知识点"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="spring知识点"/></a><div class="content"><a class="title" href="/2020/12/03/spring%E7%9F%A5%E8%AF%86%E7%82%B9/" title="spring知识点">spring知识点</a><time datetime="2020-12-03T11:49:10.000Z" title="发表于 2020-12-03 19:49:10">2020-12-03</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png)"><div id="footer-wrap"><div class="copyright">&copy;2020 By Hannibal</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a href="http://liwenchang.ren/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})</script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script></div></body></html>